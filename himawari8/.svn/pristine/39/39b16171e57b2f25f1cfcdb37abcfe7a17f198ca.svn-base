'''
Created on Sep 11, 2011

@author: tomas
'''

import numpy

from general_utils import  daytimeconv
from himawari8.sat_model.utils import prepare_sat_rast_data
from general_utils import latlon


if __name__ == '__main__':
    seg_col, seg_row = 63, 10
    
    dfb_begin = daytimeconv.yyyymmdd2dfb('20160301')
    dfb_end = daytimeconv.yyyymmdd2dfb('20160303')

    slot_begin = 1 # 1 
    slot_end = 144  # 144
    
    sat_data_path_pool = ['/home1/model_data_himawari/sat_data_procseg/']
    
    chan = 'VIS064_2000' #["VIS064_2000", "VIS160_2000", "IR390_2000", "IR124_2000"]
    SatellitesList = ["H08" ]  # in order of preference
    
    vmin=None
    vmax=None
    
    skip_empty = False
    


    satdata_suffix="_r%d_c%d" % (seg_row, seg_col)

    resolution = 2./60.
    seg_bbox = latlon.get_5x5_seg_bbox(seg_row, seg_col, resolution)
    ChannelRawDataDictionary, SatDataAvailabilityDic = prepare_sat_rast_data.readLonLatSatelliteData(dfb_begin, dfb_end, slot_begin, slot_end, SatellitesList, [chan], sat_data_path_pool, satdata_suffix, seg_bbox)

    
    data = ChannelRawDataDictionary[chan]

    print "chan:%s" % (chan)
    print "dir pool:", sat_data_path_pool
    print "valid values [perc]: %.1f" % (100*(data==data).sum()/data.size)
    print "shape:", data.shape
    print "min:%.2f, max:%.2f" % (data[data==data].min(), data[data==data].max())
    
    map_data_3d=data.reshape((data.shape[0]*data.shape[1],data.shape[2],data.shape[3]))
    

    aDS_list = []
    for dfb in range(dfb_begin,dfb_end+1):
        aDs = daytimeconv.dfb2yyyymmdd(dfb)
        for slot in range(slot_begin,slot_end+1):
            aDSs = aDs + "_%03d"%slot
            aDS_list.append(aDSs)

    aDS_arr = numpy.array(aDS_list)

    if skip_empty:     
        aux=map_data_3d.mean(axis=2).mean(axis=1)
        wh=aux> 0
        map_data_3d = map_data_3d[wh,:,:]
        aDS_arr = aDS_arr[wh]
        
    
    print 'preparing plot...'
    
    
    latlon.visualize_map_3d(map_data_3d, seg_bbox, vmin=vmin, vmax=vmax, interpolation='nearest', subplot_titles_list=aDS_arr)
    print 'DONE'

